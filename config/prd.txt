PRODUCT REQUIREMENTS DOCUMENT (PRD)
Solar Heating System with TaskMaster AI Integration
==================================================

1. PROJECT OVERVIEW
===================

Project Name: Sun Heat and FTX - Solar Heating System with AI Integration
Version: 2.0
Date: 2024
Status: Active Development

1.1 Executive Summary
---------------------
This project implements an intelligent solar heating system that combines traditional temperature monitoring and control with AI-powered task management and optimization. 
The system uses Sequent Microsystems hardware for sensor data acquisition and control, enhanced with TaskMaster AI for intelligent decision-making and system optimization.

1.2 Project Goals
-----------------
- Provide reliable temperature monitoring for solar heating systems
- Implement automated control of pumps and valves based on temperature thresholds
- Integrate AI-powered optimization for improved system efficiency
- Enable intelligent task management and decision-making
- Provide comprehensive data logging and analysis capabilities
- Ensure system safety and reliability through automated monitoring

2. SYSTEM ARCHITECTURE
======================

2.1 Hardware Components
-----------------------
- Raspberry pi Zero 2 W
- Sequent Microsystems RTD Data Acquisition boards
- Sequent Microsystems Building Automation V4 boards
- Sequent Microsystems Four Relays four HV Inputs boards
- Temperature sensors (RTD type)
- Water circulation pumps
- Storage tanks

2.2 Software Components
-----------------------
- Python-based temperature monitoring system
- TaskMaster AI integration layer
- MQTT communication protocol
- RESTful API for system control
- Web-based GUI for monitoring and control

2.3 System Integration Points
-----------------------------
- Temperature sensor data acquisition via RTD boards
- Pump control via relay outputs
- MQTT messaging for system communication
- TaskMaster AI API for intelligent task management

3. FUNCTIONAL REQUIREMENTS
==========================

3.1 Temperature Monitoring
--------------------------
FR-001: The system shall continuously monitor temperature sensors
- Monitor solar collector temperature
- Monitor storage tank temperature
- Monitor heat exchanger temperature
- Monitor return line temperature
- Update readings at configurable intervals (default: 30 seconds)

FR-002: The system shall implement temperature threshold monitoring
- High temperature threshold: 80°C (configurable)
- Low temperature threshold: 20°C (configurable)
- Automatic alert generation when thresholds are exceeded
- Configurable threshold values via environment variables
- Be able to change variables from home assistant

FR-003: The system shall provide temperature data logging
- Log all temperature readings with timestamps
- Store data in InfluxDB for historical analysis
- Export data in various formats (CSV, JSON)
- Maintain data retention policies
- Send data to home assistant

FR-003.1: The system shall calculate and monitor water heater stratification metrics
- Calculate water heater stratification quality (top_temp - bottom_temp) / height
- Monitor temperature gradient per cm in water heater
- Detect water mixing vs stratification using standard deviation analysis
- Alert when stratification quality drops below acceptable levels
- Track stratification trends over time

FR-003.2: The system shall provide operational metrics tracking
- Track cumulative pump runtime hours for maintenance scheduling
- Count heating cycles per day for usage pattern analysis
- Calculate average heating duration per cycle
- Monitor pump efficiency and performance
- Generate maintenance alerts based on runtime thresholds

FR-003.3: The system shall implement safety and protection monitoring
- Calculate overheating risk based on collector temperature vs safe limits
- Monitor freeze protection status during winter months
- Track sensor health score (percentage of sensors reporting valid data)
- Alert on system safety issues
- Log safety events for analysis

FR-003.4: The system shall provide energy efficiency calculations
- Calculate solar collector efficiency (collector_temp - ambient_temp) / solar_radiation
- Monitor heat exchanger coefficient of performance (COP)
- Track overall system efficiency metrics
- Calculate solar gain potential and available energy
- Monitor heat loss rate over time
- Calculate stored energy in water using proper physics (0-36 kWh for 360L tank)
- Validate energy calculations against realistic physical limits
- Monitor energy collection rate and daily/hourly energy totals

FR-003.5: The system shall provide predictive and economic metrics
- Estimate time to reach target temperature
- Calculate energy remaining in hours based on consumption rate
- Track energy cost savings vs traditional heating
- Monitor solar fraction (solar energy / total energy used)
- Generate economic benefit reports

3.2 Pump Control
----------------
FR-004: The system shall control water circulation pumps
- Primary pump control via relay output
- Secondary pump control via relay output
- Automatic pump activation based on temperature conditions
- Manual pump control via API, GUI or Home assistant
- Emergency stop functionality

FR-005: The system shall implement intelligent pump control
- Increase flow when high temperature detected
- Decrease flow when low temperature detected
- Optimize pump operation based on AI recommendations
- Prevent pump damage through safety controls

3.4 TaskMaster AI Integration
-----------------------------
FR-008: The system shall integrate with TaskMaster AI
- Create tasks automatically based on system conditions
- Process AI-powered optimization recommendations
- Execute tasks based on priority and system state
- Maintain task history and execution logs

FR-009: The system shall implement AI-powered optimization
- Daily system optimization analysis
- Efficiency improvement recommendations
- Predictive maintenance suggestions
- Energy consumption optimization

FR-010: The system shall provide intelligent task management
- Temperature monitoring tasks (continuous)
- Pump control tasks (on-demand)
- Valve control tasks (on-demand)
- Data logging tasks (periodic)
- System optimization tasks (daily)

FR-010.1: The system shall create AI tasks for stratification monitoring
- Create tasks to monitor water heater stratification quality
- Generate alerts when stratification drops below optimal levels
- Schedule stratification analysis tasks (hourly)
- Create optimization tasks to improve stratification
- Track stratification improvement recommendations

FR-010.2: The system shall create AI tasks for operational efficiency
- Create tasks to monitor pump runtime and efficiency
- Generate maintenance scheduling tasks based on pump usage
- Create tasks to optimize heating cycles and duration
- Schedule performance analysis tasks (daily)
- Generate efficiency improvement recommendations

FR-010.3: The system shall create AI tasks for safety monitoring
- Create tasks to monitor overheating risk levels
- Generate freeze protection tasks during winter months
- Create sensor health monitoring tasks (continuous)
- Schedule safety analysis tasks (hourly)
- Generate safety improvement recommendations

FR-010.4: The system shall create AI tasks for energy optimization
- Create tasks to monitor solar collector efficiency
- Generate heat exchanger optimization tasks
- Create tasks to track energy savings and costs
- Schedule energy analysis tasks (daily)
- Generate energy optimization recommendations

FR-010.5: The system shall create AI tasks for predictive maintenance
- Create tasks to predict maintenance needs based on runtime
- Generate predictive temperature and energy forecasts
- Create tasks to estimate time to target temperatures
- Schedule predictive analysis tasks (daily)
- Generate maintenance and optimization schedules

3.5 Data Management
-------------------
FR-011: The system shall provide comprehensive data logging
- Temperature sensor data
- Pump operation data
- Task execution data
- System efficiency metrics

FR-012: The system shall support data analysis
- Historical trend analysis
- Efficiency calculations
- Performance reporting
- Predictive analytics

3.6 User Interface
------------------
FR-013: The system shall provide web-based monitoring interface
- Real-time temperature display
- System status overview
- Control panel for manual operations
- Historical data visualization
- Task management interface

FR-014: The system shall provide API access
- RESTful API for system control
- JSON-based data exchange
- Authentication and authorization
- Rate limiting and security

FR-015: The system shall provide monitoring thru Home assistant(MQTT)
- Real-time temperature display
- System status overview
- Control panel for manual operations
- Historical data visualization
- Task management interface

3.7 System Monitoring and Watchdog
----------------------------------
FR-016: The system shall implement comprehensive health monitoring
- Network connectivity monitoring (ping 8.8.8.8, 1.1.1.1, 192.168.0.1)
- MQTT communication health monitoring
- System service status monitoring
- Automatic health check execution every 10 seconds

3.8 Heartbeat and Uptime Monitoring
-----------------------------------
FR-021: The system shall implement continuous heartbeat monitoring
- Publish heartbeat messages every 30 seconds to solar_heating_v3/heartbeat topic
- Include system status, pump states, temperature count, and uptime information
- Ensure heartbeat messages are not retained (real-time only)
- Provide heartbeat message format with JSON payload including status, timestamp, version, and system metrics

FR-022: The system shall provide uptime monitoring capabilities
- Enable external monitoring systems (e.g., Uptime Kuma) to track system health
- Support MQTT-based uptime monitoring for real-time status tracking
- Provide system state information through heartbeat messages
- Enable immediate detection of system failures or communication issues

FR-023: The system shall implement heartbeat-based health reporting
- Include primary pump status in heartbeat messages
- Include cartridge heater status in heartbeat messages
- Include temperature sensor count and system mode
- Provide timestamp and uptime information for monitoring accuracy

FR-024: The system shall support heartbeat integration with monitoring platforms
- Enable Uptime Kuma MQTT monitoring integration
- Support external monitoring system connectivity
- Provide real-time system health status
- Enable immediate alerting for system failures

FR-017: The system shall provide automated failure detection
- Network connectivity failure detection
- MQTT communication failure detection
- System service failure detection
- Configurable failure thresholds (default: 3 consecutive failures)

FR-018: The system shall implement intelligent alerting system
- MQTT alert publishing to solar_heating_v3/heartbeat/alert topic
- Configurable alert intervals (default: 5 minutes between alerts)
- Comprehensive alert message format with system status details
- Automatic alert suppression to prevent notification spam

FR-019: The system shall provide automatic recovery monitoring
- System recovery detection and logging
- Failure count reset on successful recovery
- Continuous monitoring during recovery periods
- Performance tracking and trend analysis

FR-020: The system shall ensure high availability monitoring
- 24/7 continuous health monitoring
- Automatic restart on system reboot
- Systemd service integration for reliable operation
- Comprehensive logging for troubleshooting and analysis

4. NON-FUNCTIONAL REQUIREMENTS
==============================

4.1 Performance Requirements
---------------------------
NFR-001: System response time
- Temperature reading updates: < 30 seconds
- Task execution: < 5 seconds
- API response time: < 1 second
- GUI refresh rate: < 10 seconds

NFR-002: System reliability
- 99.9% uptime requirement
- Automatic error recovery
- Graceful degradation on hardware failure
- Data backup and recovery

NFR-003: Scalability
- Support for up to 16 temperature sensors
- Support for up to 8 pump/valve controls
- Configurable task execution limits
- Horizontal scaling capability

4.2 Security Requirements
-------------------------
NFR-004: Data security
- Encrypted communication (HTTPS, MQTT over TLS)
- API key authentication for TaskMaster AI
- User authentication for web interface
- Secure storage of configuration data

NFR-005: System security
- Input validation and sanitization
- SQL injection prevention
- Cross-site scripting protection
- Regular security updates

4.3 Usability Requirements
--------------------------
NFR-006: User interface
- Intuitive web-based interface
- Mobile-responsive design
- Clear error messages and notifications
- Helpful documentation and tooltips

NFR-007: System administration
- Easy configuration management
- Simple installation and setup
- Comprehensive logging and monitoring
- Backup and restore procedures

5. TECHNICAL SPECIFICATIONS
============================

5.1 Hardware Specifications
---------------------------
- Raspberry Pi or similar single-board computer
- Sequent Microsystems RTD Data Acquisition board
- Sequent Microsystems Building Automation V4 board
- Sequent Microsystems Four Relays four HV Inputs board
- Temperature sensors (PT100 or similar RTD type)
- Network connectivity (Ethernet or WiFi)

5.2 Software Specifications
---------------------------
- Python 3.8 or higher
- InfluxDB for time-series data storage
- MQTT broker (Mosquitto or similar)
- Web server (Nginx or similar)
- TaskMaster AI API integration

5.3 Communication Protocols
---------------------------
- MQTT for real-time messaging
- HTTP/HTTPS for API communication
- Modbus RTU for hardware communication
- WebSocket for real-time web interface

6. INTEGRATION REQUIREMENTS
===========================

6.1 TaskMaster AI Integration
-----------------------------
IR-001: API Integration
- TaskMaster AI API key configuration
- Task creation and management
- AI recommendation processing
- Result logging and analysis

IR-002: Task Types
- temperature_monitoring: Continuous temperature monitoring
- pump_control: Pump operation control
- valve_control: Valve position control
- data_logging: System data logging
- system_optimization: AI-powered optimization
- stratification_monitoring: Water heater stratification quality monitoring
- operational_efficiency: Pump runtime and efficiency tracking
- safety_monitoring: Overheating and freeze protection monitoring
- energy_optimization: Solar collector and heat exchanger efficiency
- predictive_maintenance: Maintenance prediction and scheduling
- economic_tracking: Energy cost savings and economic benefits

6.2 Hardware Integration
------------------------
IR-003: Sequent Microsystems Integration
- RTD temperature sensor reading
- Relay output control for pumps
- Analog output control for valves
- Digital input monitoring
- Hardware status monitoring

6.3 External System Integration
------------------------------
IR-004: MQTT Integration
- Publish temperature data
- Subscribe to control commands
- System status broadcasting
- Error and alert messaging
- Heartbeat monitoring and health status
- Watchdog alert publishing
- System health status broadcasting

IR-005: Database Integration
- InfluxDB for time-series data
- Task execution logging
- System performance metrics
- Historical data analysis

7. DEPLOYMENT REQUIREMENTS
==========================

7.1 Installation Requirements
-----------------------------
DR-001: System Installation
- Automated installation scripts
- Dependency management
- Configuration file setup
- Service installation and configuration

DR-002: Hardware Setup
- Board installation and configuration
- Sensor wiring and calibration
- Pump and valve connection
- Network configuration

7.2 Configuration Requirements
------------------------------
DR-003: System Configuration
- Environment variable setup
- API key configuration
- Hardware address configuration
- Network and communication settings

DR-004: Service Configuration
- Systemd service configuration
- Automatic startup configuration
- Log rotation settings
- Backup configuration
- Watchdog service installation and configuration
- Health monitoring service setup
- Alert system configuration

8. TESTING REQUIREMENTS
========================

8.1 Unit Testing
-----------------
TR-001: Component Testing
- Temperature sensor reading accuracy
- Pump control functionality
- Valve control precision
- Task creation and execution
- API endpoint functionality
- Stratification calculation accuracy
- Operational metrics tracking precision
- Safety monitoring functionality
- Energy efficiency calculation accuracy
- Predictive maintenance algorithm testing
- Watchdog system health monitoring accuracy
- Network connectivity monitoring precision
- MQTT communication health detection
- System service status monitoring
- Alert system functionality and timing
- Heartbeat message generation and publishing accuracy
- Heartbeat message format and content validation
- Uptime monitoring integration testing
- External monitoring platform connectivity testing

8.2 Integration Testing
-----------------------
TR-002: System Integration
- Hardware communication testing
- MQTT messaging verification
- TaskMaster AI integration testing
- Database connectivity testing

8.3 Performance Testing
-----------------------
TR-003: System Performance
- Response time testing
- Load testing under various conditions
- Memory and CPU usage monitoring
- Network bandwidth utilization

8.4 User Acceptance Testing
---------------------------
TR-004: User Interface Testing
- Web interface functionality
- Mobile responsiveness
- User workflow validation
- Error handling verification

9. MAINTENANCE REQUIREMENTS
===========================

9.1 Operational Maintenance
---------------------------
MR-001: Regular Maintenance
- Hardware inspection and cleaning
- Software updates and patches
- Database maintenance and optimization
- Log file management

MR-002: Monitoring and Alerting
- System health monitoring
- Performance metric tracking
- Automated alert generation
- Incident response procedures
- Watchdog system health monitoring
- Network connectivity monitoring
- MQTT communication health monitoring
- System service status monitoring
- Automatic failure detection and alerting
- System recovery monitoring and logging

9.2 Backup and Recovery
-----------------------
MR-003: Data Protection
- Regular data backups
- Configuration backup procedures
- Disaster recovery planning
- Data retention policies

10. SUCCESS CRITERIA
====================

10.1 Performance Metrics
------------------------
- System uptime: > 99.9%
- Temperature reading accuracy: ±0.5°C
- Task execution success rate: > 95%
- API response time: < 1 second
- Watchdog monitoring accuracy: > 99.5%
- Health check response time: < 10 seconds
- Alert generation time: < 30 seconds after failure detection
- Heartbeat message frequency: Every 30 seconds ±2 seconds
- Heartbeat message delivery reliability: > 99.9%
- Uptime monitoring response time: < 60 seconds

10.2 Efficiency Improvements
----------------------------
- Energy consumption reduction: > 15%
- System efficiency improvement: > 10%
- Maintenance cost reduction: > 20%
- User satisfaction: > 90%

10.3 Operational Goals
----------------------
- Automated system operation: > 95%
- Manual intervention reduction: > 80%
- Data accuracy: > 99%
- System reliability: > 99.9%

11. RISK ASSESSMENT
===================

11.1 Technical Risks
--------------------
- Hardware failure and replacement
- Software compatibility issues
- Network connectivity problems
- Data loss or corruption

11.2 Operational Risks
-----------------------
- Power supply interruptions
- Environmental damage
- User error and misuse
- Security breaches

11.3 Mitigation Strategies
--------------------------
- Redundant hardware components
- Regular backup procedures
- Comprehensive testing protocols
- Security best practices implementation

12. FUTURE ENHANCEMENTS
========================

12.1 Planned Features
---------------------
- Machine learning-based predictive maintenance
- Advanced energy optimization algorithms
- Mobile application development
- Cloud-based data analytics
- Integration with smart home systems
- Advanced stratification analysis and optimization
- Real-time economic benefit tracking and reporting
- Predictive temperature and energy forecasting
- Advanced safety monitoring and alerting systems
- Comprehensive operational efficiency analytics
- Advanced watchdog analytics and machine learning
- Predictive failure detection and prevention
- Enhanced alerting and notification systems
- Integration with external monitoring platforms
- Advanced health scoring and trend analysis

12.2 Scalability Plans
----------------------
- Multi-site system support
- Cloud-based deployment options
- Advanced AI capabilities
- Enhanced user interface features

13. RECENT UPDATES AND IMPROVEMENTS
===================================

13.1 Energy Calculation System Fix (Latest Update)
--------------------------------------------------
**Issue Identified**: System was displaying unrealistic energy values (800+ kWh) in the dashboard due to incorrect calculation multipliers.

**Root Cause**: The stored energy calculation used an arbitrary multiplier (`* 35`) instead of proper physics-based calculations.

**Solution Implemented**: 
- Replaced arbitrary multiplier with proper physics calculations for 360L water tank
- Energy calculation now uses: mass × specific_heat_capacity × temperature_difference
- Added energy range validation (0-36 kWh for 360L tank from 4°C to 90°C)
- Enhanced logging with energy calculation validation warnings

**Technical Details**:
- Tank volume: 360 liters = 360 kg of water
- Specific heat capacity: 4.2 kJ/kg°C for water
- Temperature range: 4°C (well water) to 90°C (max tank temperature)
- Maximum energy: ~36 kWh (realistic for residential system)

**Files Modified**: `python/v3/main_system.py`
**Documentation Updated**: USER_GUIDE, IMPLEMENTATION, SUMMARY, and CHANGELOG documents

**Result**: Energy values now show realistic range (0-36 kWh) based on actual tank volume and water properties, providing accurate monitoring data for system optimization.

14. CONCLUSION
==============

This PRD outlines the comprehensive requirements for the Solar Heating System with TaskMaster AI Integration. The system combines traditional temperature monitoring and control with modern AI-powered optimization to create an intelligent, efficient, and reliable solar heating solution.

The integration of TaskMaster AI provides intelligent task management, automated decision-making, and system optimization capabilities that significantly enhance the performance and efficiency of the solar heating system.

Success of this project will be measured by improved system efficiency, reduced energy consumption, increased automation, and enhanced user satisfaction through intelligent system management and optimization.
